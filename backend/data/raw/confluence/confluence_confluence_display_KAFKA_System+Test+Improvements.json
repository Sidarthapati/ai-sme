{
  "id": "confluence_display_KAFKA_System+Test+Improvements",
  "title": "System Test Improvements - Apache Kafka - Apache Software Foundation",
  "content": "PROPOSAL\nThe following is a proposal to update and improve the Kafka system tests.\nMotivation\nThe existing system tests have been around for a few years, but not as much subsequent development effort has gone here as is needed. Consequently, technical debt has accrued. For each new feature, we often have a standalone program to test it, but generally those programs are not integrated into system tests and tend to become obsolete over time.\nAs Kafka matures, our system tests need to graduate to first-class citizens so that we can be more confident in the stability of the overall system as well as compatibility etc.\nCurrent system tests are:\nUnstable - relatively little maintenance effort has gone in, and many are now redundant or simply too unstable to run successfully.\nIncomplete - there are significant gaps in coverage\nHard to read - Community members have complained that the existing framework is hard to read/understand and therefore difficult to develop new tests against.\nWhat do we want out of system tests going forward?\nFrom “things we can test” perspective, we need convenient ways to do:\nSanity checks for normal conditions and operations (e.g. soft bouncing of services)\nFailures (e.g. bounce/hard bounce/chaos tests)\nHigh load\nNetwork errors or failures (partitions, loss, or high latencies)\nRun against different combinations of versions to test version compatibility.\nFrom a dev perspective, we need:\nEasy to run ‘in the cloud’ or locally without tweaky config changes,\nEasy-ish to automate (nightly runs)\nPossible to run multiple tests in parallel on different machines.\nNice reporting, with regression checks against performance statistics.\nMore readable/better structured to encourage community members to develop tests.\nPlan of Action\nThe rough plan to move forward is as follows:\nPick a new framework, or develop one\nWe chose to use ducktape (\nhttps://github.com/confluentinc/ducktape\n- see notes below)\nIdentify “MVP” tests - i.e. a set of high priority tests to fill in major gaps in our existing system test coverage (see further notes below)\nIdentify “long tail” of less urgent tests.\nStabilize and prune existing system tests so they can be run regularly until they are ported(?)\nFramework Choice\nWe evaluated Zopkio (\nhttps://github.com/linkedin/Zopkio\n) which is used internally at LinkedIn for Samza and other projects, and Confluent’s ducktape (\nhttps://github.com/confluentinc/ducktape\n) which is used in system tests for the Confluent Platform (\nhttps://github.com/confluentinc/muckrake)\nand concluded that ducktape better matched our use case (see comparison table below). Continued development on ducktape is needed, but it is far enough along to be a useful tool for a wide variety of system tests.\nducttape\nzopkio\nrunnable on cloud or locally (provisioning capability)\nyes\nno\ncluster management\nyes\nno\nrun tests in parallel\nnot implemented, but written with this use case in mind\nuse of globals makes this harder\neasy to read/understand\nsomewhat\nsomewhat\ngood reporting\nyes\nyes\nregression\nnot yet\nyes (at least, naarad claims to support this)\nautomatable\nyes - has flexible test discovery mechanism\ntest suites run in a self-contained way, but a script to drive multiple test suites would still be needed\nTest Coverage\nAmong other things, we want to include those standalone programs into our system test so that we have reasonable coverage on each important feature.\n1. Performance: Need to collect the performance numbers regularly and make sure there is no significant regression.\nSetup:  3-node cluster, replication factor 3, 1 topic with 3000 partitions.\n1.1 ProducerPerformance:\nminimal: measure the throughput of a single producer with a few different configurations (ack =1/all, compression=none/gzip)\nnice to have: extend the test to multiple producers\nNote: There is system_test/producer_perf, but it's based on the old ProducerPerformance. We need to either replace it or create a new test and delete the old one.\n1.2 ConsumerPerformance:\nminimal: measure the throughput of a single consumer with a few different configurations (compression=none/gzip)\nnice to have: extend the test to multiple consumers\n1.3 TestEndToEndLatency: This test measures the end to end latency from the time a message is produced to the time the message is consumed.\nProbably need to get KAFKA-1983 fixed first.\n2. Feature correctness: Need to make sure there are no errors when testing existing features.\nSetup: All tests can be done on a single node cluster.\n2.1 TestLogCleaning: This test stress tests the log compaction logic.\n2.2 TestOffsetManager: Need to understand a bit more how the test works and its relationship with the offset management suite in system_test.\n2.3 KafkaLog4jAppender: Somehow need to make sure that it works. Perhaps we also need to improve the appender itself.\n3. Admin Tools testing:\n3.1 partition reassignment: load some data; trigger partition assignment, bounce the broker a few times, make sure partition reassignment can complete in the end and there is no data loss.\n3.2 leader balancing: bounce broker, make sure leaders balanced after auto-leader balancing time and there is no data loss.\n3.3 delete topic\n4. System tests: We need to pick a subset of important existing tests. Make sure they are stable and run regularly.\n4.1 a few leader failure tests\n4.2 a few controller failure tests\n4.3 a few mirror maker tests\n4.4 offset management suite (need to figure out its relationship with TestOffsetManager)\n5. Compatibility tests:\n5.1 Wire protocol: This will get better after we move all requests to the new protocol definition. However, in addition to making sure that the existing wire protocol doesn't change, it would be useful to also check the semantics, e.g. whether the client is getting the same response value as before.\n5.2 Upgrades: Whether we can upgrade the broker with existing data and configs from an older version.",
  "url": "https://cwiki.apache.org/confluence/display/KAFKA/System+Test+Improvements",
  "space": "KAFKA",
  "labels": [],
  "last_modified": null,
  "source_type": "confluence"
}