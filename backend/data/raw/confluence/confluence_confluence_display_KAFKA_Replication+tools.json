{
  "id": "confluence_display_KAFKA_Replication+tools",
  "title": "Replication tools - Apache Kafka - Apache Software Foundation",
  "content": "1. Preferred Replica Leader Election Tool\nWhat does the tool do?\nWith replication, each partition can have multiple replicas. The list of replicas for a partition is called the \"assigned replicas\". The first replica in this list is the \"preferred replica\". When topic/partitions are created, Kafka ensures that the \"preferred replica\" for the partitions across topics are equally distributed amongst the brokers in a cluster. In an ideal scenario, the leader for a given partition should be the \"preferred replica\". This guarantees that the leadership load across the brokers in a cluster are evenly balanced. However, over time the leadership load could get imbalanced due to broker shutdowns (caused by controlled shutdown, crashes, machine failures etc). This tool helps to restore the leadership balance between the brokers in the cluster. A summary of the steps that the tool does is shown below -\n1. The tool updates the zookeeper path \"/admin/preferred_replica_election\" with the list of topic partitions whose leader needs to be moved to the preferred replica.\n2. The controller listens to the path above. When a data change update is triggered, the controller reads the list of topic partitions from zookeeper.\n3. For each topic partition, the controller gets the preferred replica (the first replica in the assigned replicas list). If the preferred replica is not already the leader and it is present in the isr, the controller issues a request to the broker that owns the preferred replica to become the leader for the partition.\nNote that the tool only updates the zookeeper path and exits. The controller moves the leader for a partition to the preferred replica asynchronously.\nHow to use the tool?\nbin/kafka-preferred-replica-election.sh --zookeeper localhost:12913/kafka --path-to-json-file topicPartitionList.json\nThe tool takes a mandatory list of zookeeper hosts and an optional list of topic partitions provided as a json file. If the list is not provided, the tool queries zookeeper and gets all the topic partitions for the cluster. The tool exits after updating the zookeeper path \"/admin/preferred_replica_election\" with the topic partition list.\nExample json file (This is optional. This can be specified to move the leader to the preferred replica for specific topic partitions)\n{\n\"partitions\":\n[\n{\"topic\": \"topic1\", \"partition\": 0},\n{\"topic\": \"topic1\", \"partition\": 1},\n{\"topic\": \"topic1\", \"partition\": 2},\n{\"topic\": \"topic2\", \"partition\": 0},\n{\"topic\": \"topic2\", \"partition\": 1}\n]\n}\nFAQ\nWhat happens if the preferred replica is not in the ISR?\nThe controller will fail to move the leadership to the preferred replica if it is not in the ISR. This is to ensure that there is no dataloss. When the replica becomes \"in-sync\" with the leader, the tool can be run again to move the leader.\nHow to find if all the partitions have been moved to the \"preferred replica\" after running the tool?\nListTopicCommand is an excellent tool that provides an overview of all the topic partitions in the cluster. For each topic partition, it displays the leader, assigned replicas and current \"in-sync\" replica set. If the leader and the first replica in the assigned replica set are the same then the Preferred replica leader election\" tool succeeded. If not, the tool failed and may have to be run again.\n2. Topics tool\nKafka topics tool is handling all management operations related to topics:\nList and describe topics\nCreate topics\nChange topics\nDelete topics\n2.1 List and describe Topics\nWhat does the tool do?\nThis tool lists the information for a given list of topics. If no topics are provided in the command line, the tool queries zookeeper to get all the topics and lists the information for them. The fields that the tool displays are - topic name, partition, leader, replicas, isr. Two optional arguments can be provided to the tool. If \"under-replicated-partitions\" is specified, the tool only provides information for those topic / partitions which have replicas that are under replicated. If \"unavailable-partitions\" is specified, the tool only provides information for those topic/partitions whose leader is not available.\nHow to use the tool?\n# List only single topic named \"topic1\" (prints only topic name)\nbin/kafka-topics.sh --list --zookeeper localhost:2121 --topic topic1\n# List all topics (prints only topic names)\nbin/kafka-topics.sh --list --zookeeper localhost:2121\n# Describe only single topic named \"topic1\" (prints details about the topic)\nbin/kafka-topics.sh --describe --zookeeper localhost:2121 --topic topic1\n# Describe all topics (prints details about the topics)\nbin/kafka-topics.sh --describe --zookeeper localhost:2121\n# List info for topics which have under replicated count\nbin/kafka-topics.sh --describe --zookeeper localhost:2121 --under-replicated-partitions\n# List info for topics whose leader for a partition is not available\nbin/kafka-topics.sh --describe --zookeeper localhost:2121 --unavailable-partitions\n2.2 Create Topics\nWhat does the tool do?\nBy default, Kafka auto creates topic if \"auto.create.topics.enable\" is set to true on the server. This creates a topic with a default number of partitions, replication factor and uses Kafka's default scheme to do replica assignment. Sometimes, it may be required that we would like to customize a topic while creating it. This tool helps to create a topic and also specify the number of partitions, replication factor and replica assignment list for the topic.\nHow to use the tool?\n# Create topic with default settings\nbin/kafka-topics.sh --create --zookeeper localhost:2181 --topic topic1\n# Create topic with specific number of partitions and/or replicas\nbin/kafka-topics.sh --create --zookeeper localhost:2181 --topic topic1 --replication-factor 3 --partitions 3\n# Create topic with manual replica assignment\nbin/kafka-topics.sh --create --zookeeper localhost:2181 --topic topic1 --replica-assignment 0:1:2,0:1:2,0:1:2\n# Create topic with configuration override\nbin/kafka-topics.sh --create --zookeeper localhost:2181 --topic topic1 --config min.insync.replicas=1\n2.3 Add Partition to Topic\nWhat does the tool do?\nIn Kafka partitions act as the unit of parallelism: messages of a single topic are distributed to multiple partitions that can be stored and served on different servers. Upon creation of a topic, the number of partitions for this topic has to be specified. Later on more partitions may be needed for this topic when the volume of this topic increases. This tool helps to add more partitions for a specific topic and also allow manual replica assignment of the added partitions.\nHow to use the tool?\n# Increase number of partitions for topic\nbin/kafka-topics.sh --alter --zookeeper localhost:2181 --topic topic1 --partitions 4\n# Increase number of partitions with specific replica assignment\nbin/kafka-topics.sh --alter --zookeeper localhost:2181 --topic topic1 --replica-assignment 0:1:2,0:1:2,0:1:2,2:1:0 --partitions 4\n2.4 Delete Topic\nWhat does the tool do?\nWhen topic deletion is enabled in the broker (\ndelete.topic.enable\n), topics can be deleted using the Kafka Topics tool.\nHow to use the tool?\n# Delete topic named topic1\nbin/kafka-topics.sh --delete --zookeeper localhost:2181 --topic topic1\n3. Change topic configuration\nWhat does the tool do?\nKafka Confings tool can be used to modify topic configuration:\nAdd new config options\nChange existing config options\nRemove config options\nHow to use the tool?\n# Add new option or change exsiting option\nbin/kafka-configs.sh --alter --zookeeper localhost:2181 --entity-name topic1 --entity-type topics --add-config cleanup.policy=compact\n# Remove exsiting option\nbin/kafka-configs.sh --alter --zookeeper localhost:2181 --entity-name topic1 --entity-type topics --delete-config cleanup.policy\n4. Reassign Partitions Tool\nWhat does the tool do?\nThe goal of this tool is similar to the Preferred Replica Leader Election Tool as to achieve load balance across brokers. But instead of only electing a new leader from the assigned replicas of a partition, this tool allows to change the assigned replicas of partitions – remember that followers also need to fetch from leaders in order to keep in sync, hence sometime only balance the leadership load is not enough.\nA summary of the steps that the tool does is shown below -\n1. The tool updates the zookeeper path \"/admin/reassign_partitions\" with the list of topic partitions and (if specified in the Json file) the list of their new assigned replicas.\n2. The controller listens to the path above. When a data change update is triggered, the controller reads the list of topic partitions and their assigned replicas from zookeeper.\n3. For each topic partition, the controller does the following:\n3.1. Start new replicas in RAR - AR (RAR = Reassigned Replicas, AR = original list of Assigned Replicas)\n3.2. Wait until new replicas are in sync with the leader\n3.3. If the leader is not in RAR, elect a new leader from RAR\n3.4 4. Stop old replicas AR - RAR\n3.5. Write new AR\n3.6. Remove partition from the /admin/reassign_partitions path\nNote that the tool only updates the zookeeper path and exits. The controller reassign the replicas for the partitions asynchronously.\nHow to use the tool?\nbin/kafka-reassign-partitions.sh\nOption                                 Description\n------                                 -----------\n--bootstrap-server <String: Server(s)  the server(s) to use for\nto use for bootstrapping>              bootstrapping. REQUIRED if an\nabsolution path of the log directory\nis specified for any replica in the\nreassignment json file\n--broker-list <String: brokerlist>     The list of brokers to which the\npartitions need to be reassigned in\nthe form \"0,1,2\". This is required\nif --topics-to-move-json-file is\nused to generate reassignment\nconfiguration\n--disable-rack-aware                   Disable rack aware replica assignment\n--execute                              Kick off the reassignment as specified\nby the --reassignment-json-file\noption.\n--generate                             Generate a candidate partition\nreassignment configuration. Note\nthat this only generates a candidate\nassignment, it does not execute it.\n--reassignment-json-file <String:      The JSON file with the partition\nmanual assignment json file path>      reassignment configurationThe format\nto use is -\n{\"partitions\":\n[{\"topic\": \"foo\",\n\"partition\": 1,\n\"replicas\": [1,2,3],\n\"log_dirs\": [\"dir1\",\"dir2\",\"dir3\"]\n}],\n\"version\":1\n}\nNote that \"log_dirs\" is optional. When\nit is specified, its length must\nequal the length of the replicas\nlist. The value in this list can be\neither \"any\" or the absolution path\nof the log directory on the broker.\nIf absolute log directory path is\nspecified, it is currently required\nthat the replica has not already\nbeen created on that broker. The\nreplica will then be created in the\nspecified log directory on the\nbroker later.\n--throttle <Long: throttle>            The movement of partitions will be\nthrottled to this value (bytes/sec).\nRerunning with this option, whilst a\nrebalance is in progress, will alter\nthe throttle value. The throttle\nrate should be at least 1 KB/s.\n(default: -1)\n--timeout <Long: timeout>              The maximum time in ms allowed to wait\nfor partition reassignment execution\nto be successfully initiated\n(default: 10000)\n--topics-to-move-json-file <String:    Generate a reassignment configuration\ntopics to reassign json file path>     to move the partitions of the\nspecified topics to the list of\nbrokers specified by the --broker-\nlist option. The format to use is -\n{\"topics\":\n[{\"topic\": \"foo\"},{\"topic\": \"foo1\"}],\n\"version\":1\n}\n--verify                               Verify if the reassignment completed\nas specified by the --reassignment-\njson-file option. If there is a\nthrottle engaged for the replicas\nspecified, and the rebalance has\ncompleted, the throttle will be\nremoved\n--zookeeper <String: urls>             REQUIRED: The connection string for\nthe zookeeper connection in the form\nhost:port. Multiple URLS can be\ngiven to allow fail-over.\nPlease note that by default the script runs in a dry-run mode and does not initiate the partition movement. Only when the --execute option is specified, the tool proceeds to start the partition movement\nCluster Expansion\nThe partition reassignment tool can be used to expand an existing Kafka cluster. Cluster expansion involves including brokers with new broker ids in a Kafka cluster. Typically, when you add new brokers to a cluster, they will not receive any data from existing topics until this tool is run to assign existing topics/partitions to the new brokers. The tool allows 2 options to make it easier to move some topics in bulk to the new brokers. These 2 options are a) topics to move b) list of newly added brokers. Using these 2 options, the tool automatically figures out the placements of partitions for the topics on the new brokers and generates new JSON data which can be used in the next step (with the\n--reassignment-json-file\noption) to execute the move.\nThe following example moves 2 topics (foo1, foo2) to newly added brokers in a cluster (5,6,7)\n$ ./bin/kafka-reassign-partitions.sh --topics-to-move-json-file topics-to-move.json --broker-list \"5,6,7\" --generate --zookeeper localhost:2181\n$ cat topics-to-move.json\n{\"topics\":\n[{\"topic\": \"foo1\"},{\"topic\": \"foo2\"}],\n\"version\":1\n}\nSelectively moving some partitions to a broker\nThe partition movement tool can also be moved to selectively move some replicas for certain partitions over to a particular broker. Typically, if you end up with an unbalanced cluster, you can use the tool in this mode to selectively move partitions around. In this mode, the tool takes a single file which has a list of partitions to move and the replicas that each of those partitions should be assigned to.\nThe following example moves 1 partition (foo-1) from replicas\n1,2,3\nto\n1,2,4\n$ ./bin/kafka-reassign-partitions.sh --reassignment-json-file partitions-to-move.json --execute\n$ cat partitions-to-move.json\n{\"partitions\":\n[{\"topic\": \"foo\",\n\"partition\": 1,\n\"replicas\": [1,2,4] }],\n\"version\":1\n}\n5. StateChangeLogMerger Tool\nWhat does the tool do ?\nThe goal of this tool is to collect data from the brokers in a cluster and format it in a central log to help troubleshoot issues with state changes. Every broker in a Kafka cluster emits a state-change.log that logs the lifecycle of every state change received by the broker. Often times, there is some problem with leader election for a subset of topics/partitions and the question is what caused the problem. In order to answer this question, we need a global view of state changes in the kafka cluster, possibly filtered on a time range and/or specific topics/partitions. This is exactly what the StateChangeLogMerger tool does. It takes in a list of state-change.log files, merges them in time order, filters on a certain time range if specified by the user, filters on topics/partitions if specified by the user, and outputs a merged and formatted state-change.log that is easy to query and understand the root cause.\nHow to use the tool ?\nnnarkhed-mn:kafka-git-idea nnarkhed$ ./bin/kafka-run-class.sh kafka.tools.StateChangeLogMerger\nProvide arguments to exactly one of the two options \"[logs]\" or \"[logs-regex]\"\nOption                                  Description\n------                                  -----------\n--end-time <end timestamp in the        The latest timestamp of state change\nformat java.text.                       log entries to be merged (default:\nSimpleDateFormat@f17a63e7>              9999-12-31 23:59:59,999)\n--logs <file1,file2,...>                Comma separated list of state change\nlogs or a regex for the log file\nnames\n--logs-regex <for example: /tmp/state-  Regex to match the state change log\nchange.log*>                            files to be merged\n--partitions <0,1,2,...>                Comma separated list of partition ids\nwhose state change logs should be\nmerged\n--start-time <start timestamp in the    The earliest timestamp of state change\nformat java.text.                       log entries to be merged (default:\nSimpleDateFormat@f17a63e7>              0000-00-00 00:00:00,000)\n--topic <topic>                         The topic whose state change logs\nshould be merged",
  "url": "https://cwiki.apache.org/confluence/display/KAFKA/Replication+tools",
  "space": "KAFKA",
  "labels": [],
  "last_modified": null,
  "source_type": "confluence"
}