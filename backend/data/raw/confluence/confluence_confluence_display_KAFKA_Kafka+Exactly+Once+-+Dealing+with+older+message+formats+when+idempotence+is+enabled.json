{
  "id": "confluence_display_KAFKA_Kafka+Exactly+Once+-+Dealing+with+older+message+formats+when+idempotence+is+enabled",
  "title": "Kafka Exactly Once - Dealing with older message formats when idempotence is enabled - Apache Kafka - Apache Software Foundation",
  "content": "Background\nIn the discussion of\nKIP-185: Make exactly once in order delivery per partition the default producer setting\n, it was realized that we don't have graceful handling when an idempotence-enabled producer is writing to a broker with a message format older than v2 (ie. the 0.11.0 message format).\nIn particular, if we enable idempotence, any produce requests to topics with an older message format will fail with an\nUnsupportedVersionException\n. Thus if the idempotent producer was to be made the default, the out of the box producer would fail to produce when used with clusters which haven't upgraded the message format yet.\nThis is particularly problematic since the recommended upgrade path is to upgrade broker code while keeping the message format at the older version, then upgrade all clients, and only finally upgrade the message format on the server. With the current behavior, the middle step is actually untenable if we enable idempotence as the default.\nDesign\nTo solve this problem, we propose introducing a new idempotence mode in 1.0.0, ie.\nenable.idempotence=requested\n. The other modes would be\nenable.idempotence=off\nand\nenable.idempotence=required.\nIn the\nrequested\nmode, idempotence would be best effort, ie. you get it if the broker supports it, otherwise no error is raised. In\nrequired\nmode, requests would fail if the broker did not support idempotence. In\noff\nmode, there is no idempotence (similar to the\nfalse\nvalue today).\nThe new\nenable.idempotence=requested\nmode would be introduced in the 1.0.0 release. In addition, the 1.0.0 client will disable idempotence if the message format of the destination topic doesn't support it.. In required mode, the client will raise an error if it detects an incompatible message format.\nThis means we would need to upgrade the\nTopicMetadata\nin the MetadataResponse version to include the version of the message format for the topic in question.\nAdditionally, if a 1.0.0 client with\nenable.idempotence=requested\nis writing to an 0.11.0 broker, idempotence will be disabled.\nFinally, a 1.0.0 producer would interpret\nenable.idempotence=true\nas\nenable.idempotence=required\nand\nenable.idempotence=false\nas\nenable.idempotence=off\n.\nLevel of Effort\nUpdate MetadataResponse to include the message format version - 1 day\nUse the message format version to determine whether a partition supports idempotence - 5 days.\nClient side changes to send the idempotent producer mode, interpret old configurations of\nenable.idempotence\nâ€“ 0.5 days.\nTotal: 6.5",
  "url": "https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Exactly+Once+-+Dealing+with+older+message+formats+when+idempotence+is+enabled",
  "space": "KAFKA",
  "labels": [],
  "last_modified": null,
  "source_type": "confluence"
}