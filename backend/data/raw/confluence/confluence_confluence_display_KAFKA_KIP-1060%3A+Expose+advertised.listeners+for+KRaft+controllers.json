{
  "id": "confluence_display_KAFKA_KIP-1060%3A+Expose+advertised.listeners+for+KRaft+controllers",
  "title": "KIP-1060: Expose advertised.listeners for KRaft controllers - Apache Kafka - Apache Software Foundation",
  "content": "This page is meant as a template for writing a\nKIP\n. To create a KIP choose Tools->Copy on this page and modify with your content and replace the heading with the next KIP number and a description of your issue. Replace anything in italics with your own description.\nStatus\nCurrent state\n: Rejected as already being implemented as part of\nKIP-853: KRaft Controller Membership Changes\nDiscussion thread\n:\nhere\n[Change the link from the KIP proposal email archive to your own email thread]\nJIRA\n:\nhere\nPlease keep the discussion on the mailing list rather than commenting on the wiki (wiki discussions get unwieldy fast).\nMotivation\nKafka Admin clients which support\nKIP-919\nare able to target KRaft controllers directly. This was introduced to allow performing administrative operations without involving brokers, such as DESCRIBE_QUORUM and INCREMENTAL_ALTER_CONFIGS (for log4j level changes). However, we don’t allow users to configure advertised.listeners for clients to connect to controllers, as it is a forbidden configuration for controllers. Without this configuration, the clients may not be able to connect to controllers if they are sitting behind the NAT network while the client is in the external network.\nCurrently Kafka controllers’ endpoint information are based on the\nlisteners\nconfigurations. When\nbootstrap.controller\nis set, the AdminClient uses\nDescribeClusterRequest\nto obtain the cluster topology. The response for this request contains the endpoint information for the active controller and the subsequent requests from the client are sent to this endpoint. This means if the\nlisteners\nconfiguration for controllers is set to\nlocalhost\nwhich is in most cases, the AdminClient would end up sending the subsequent requests to\nlocalhost\n.\nThe\nlisteners\nconfiguration can be set with the actual hostname address of the controllers so that the clients on the external network can use it to talk to them. However this would mean that when a controller starts up, it would immediately try to bind to the configured address, which may not be possible due to various reasons. For example, when running on Kubernetes, the DNS may not be updated yet with the dynamic IP of the new pod, if the controller just had been restarted. Another example would be Kafka cluster running in a dedicated production environment and admin clients running in an operational network that is linked to the production network but it is not the same network. In this case, the user might use some bastion hosts to forward the connection through. The controllers talk with each using their IPs or internal hostnames but the admin clients might need to talk to them through some bastion DNS names. In both examples, the controllers may not be able to bind to the host address and result in crashing with a fatal error. Yet another example where the current implementation might not work is when the broker is running with multiple different networks attached. In that case, it needs to listen on all interfaces (i.e. on 0.0.0.0) rather than on a single hostname or IP address that will be later advertised.\nPublic Interfaces\nadvertised.listeners configuration\nWe will remove the current restriction on configuring\nadvertised.listeners\nfor controllers. If\nadvertised.listeners\nis not defined, it will fallback to\nlisteners\nconfiguration like brokers. Currently, the endpoint for a controller is created using the listeners defined in the\ncontroller.listener.names\n. This will be changed to use the\nadvertised.listeners\ninstead. So when\nadvertised.listeners\nis not defined, the configuration will fall back to the current behavior of using the listeners specified in the\ncontroller.listeners.names\n.\nProposed Changes\nWhen defining listeners for controllers, various validation checks take place, one of which is to restrict defining\nadvertised.listeners\n. As already mentioned, this validation check will be removed but also a new validation will be put for controller’s\nadvertised.listeners\n. The listeners defined in\nadvertised.listeners\nmust appear in the configured\ncontroller.listener.names.\nThere are also validations for requiring configured values for\nlisteners\nto appear in\ncontroller.listener.names\nand vice versa. These validations will stay the same.\nControllers will continue using the addresses specified in\ncontroller.quorum.voters\nto communicate with each other and brokers will continue using these addresses to communicate with the controllers.  This allows you to configure the discovery mechanism for inter-controller and broker to controller communication separately from how admin clients connect to the controllers.\nCurrently, both brokers and combined nodes are restricted from including any controller listeners in their\nadvertised.listeners\nconfigurations. This restriction will be lifted for combined nodes, allowing users to advertise both broker and controller listeners.\nFor example, users may have a controller quorum that includes both dedicated controller nodes and combined nodes. They would initialise\nAdminClient\nwith\nbootstrap.controller\nset to their endpoints that must be of the controller type.\nHowever, this restriction will remain for brokers because we do not want to advertise any controller listeners from the brokers. Requests intended for controllers that are sent to brokers are forwarded to the controllers, and the responses are handled by the brokers.\nCompatibility, Deprecation, and Migration Plan\nThis change will not impact existing users in terms of controller configuration and operation. There is no old behavior to phase out; we are simply introducing a new configuration option for controllers. If this option is not set, it will fall back to the existing behavior, using the\nlisteners\nfor controller endpoints in the responses to\nAdminClient\nrequests.\nTest Plan\nWe will update the existing unit tests for Kafka configurations and add new test cases to the existing Admin integration tests to cover scenarios where a client communicates with controllers configured with\nadvertised.listeners\n. Additionally, we will update the documentation and the\ncontroller.properties\ntemplate file with a commented-out\nadvertised.listeners\nfield, along with a description.\nRejected Alternatives\nWe could potentially change the controller to build\nDescribeClusterResponse\nusing the endpoints from\ncontroller.quorum.voters\n. However, this configuration is intended for internal communication within the quorum, particularly for quorum elections, and it doesn't seem appropriate for use by admin clients. Additionally, this approach would not allow users the flexibility to separately configure how clients communicate with controllers versus how controllers and brokers communicate with each other.",
  "url": "https://cwiki.apache.org/confluence/display/KAFKA/KIP-1060%3A+Expose+advertised.listeners+for+KRaft+controllers",
  "space": "KAFKA",
  "labels": [],
  "last_modified": null,
  "source_type": "confluence"
}