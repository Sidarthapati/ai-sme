{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_admin_KafkaAdminClient.java_521",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "content": "        AdminClientConfig config,\n        TimeoutProcessorFactory timeoutProcessorFactory,\n        HostResolver hostResolver\n    ) {\n        Metrics metrics = null;\n        NetworkClient networkClient = null;\n        Time time = Time.SYSTEM;\n        String clientId = generateClientId(config);\n        ApiVersions apiVersions = new ApiVersions();\n        LogContext logContext = createLogContext(clientId);\n        Optional<ClientTelemetryReporter> clientTelemetryReporter;\n\n        try {\n            // Since we only request node information, it's safe to pass true for allowAutoTopicCreation (and it\n            // simplifies communication with older brokers)\n            AdminBootstrapAddresses adminAddresses = AdminBootstrapAddresses.fromConfig(config);\n            AdminMetadataManager metadataManager = new AdminMetadataManager(logContext,\n                config.getLong(AdminClientConfig.RETRY_BACKOFF_MS_CONFIG),\n                config.getLong(AdminClientConfig.METADATA_MAX_AGE_CONFIG),\n                adminAddresses.usingBootstrapControllers());\n            metadataManager.update(Cluster.bootstrap(adminAddresses.addresses()), time.milliseconds());\n            List<MetricsReporter> reporters = CommonClientConfigs.metricsReporters(clientId, config);\n            clientTelemetryReporter = CommonClientConfigs.telemetryReporter(clientId, config);\n            clientTelemetryReporter.ifPresent(reporters::add);\n            Map<String, String> metricTags = Collections.singletonMap(\"client-id\", clientId);\n            MetricConfig metricConfig = new MetricConfig().samples(config.getInt(AdminClientConfig.METRICS_NUM_SAMPLES_CONFIG))\n                .timeWindow(config.getLong(AdminClientConfig.METRICS_SAMPLE_WINDOW_MS_CONFIG), TimeUnit.MILLISECONDS)\n                .recordLevel(Sensor.RecordingLevel.forName(config.getString(AdminClientConfig.METRICS_RECORDING_LEVEL_CONFIG)))\n                .tags(metricTags);\n            MetricsContext metricsContext = new KafkaMetricsContext(JMX_PREFIX,\n                config.originalsWithPrefix(CommonClientConfigs.METRICS_CONTEXT_PREFIX));\n            metrics = new Metrics(metricConfig, reporters, time, metricsContext);\n            networkClient = ClientUtils.createNetworkClient(config,\n                clientId,\n                metrics,\n                \"admin-client\",\n                logContext,\n                apiVersions,\n                time,\n                1,\n                (int) TimeUnit.HOURS.toMillis(1),\n                null,\n                metadataManager.updater(),\n                (hostResolver == null) ? new DefaultHostResolver() : hostResolver,\n                null,\n                clientTelemetryReporter.map(ClientTelemetryReporter::telemetrySender).orElse(null));\n            return new KafkaAdminClient(config, clientId, time, metadataManager, metrics, networkClient,\n                timeoutProcessorFactory, logContext, clientTelemetryReporter);\n        } catch (Throwable exc) {\n            closeQuietly(metrics, \"Metrics\");\n            closeQuietly(networkClient, \"NetworkClient\");\n            throw new KafkaException(\"Failed to create new KafkaAdminClient\", exc);\n        }\n    }\n\n    // Visible for tests\n    static KafkaAdminClient createInternal(AdminClientConfig config,\n                                           AdminMetadataManager metadataManager,\n                                           KafkaClient client,\n                                           Time time) {\n        Metrics metrics = null;\n        String clientId = generateClientId(config);\n        List<MetricsReporter> reporters = CommonClientConfigs.metricsReporters(clientId, config);\n        Optional<ClientTelemetryReporter> clientTelemetryReporter = CommonClientConfigs.telemetryReporter(clientId, config);\n        clientTelemetryReporter.ifPresent(reporters::add);\n\n        try {\n            metrics = new Metrics(new MetricConfig(), reporters, time);\n            LogContext logContext = createLogContext(clientId);\n            return new KafkaAdminClient(config, clientId, time, metadataManager, metrics,\n                client, null, logContext, clientTelemetryReporter);\n        } catch (Throwable exc) {\n            closeQuietly(metrics, \"Metrics\");\n            throw new KafkaException(\"Failed to create new KafkaAdminClient\", exc);\n        }\n    }\n\n    static LogContext createLogContext(String clientId) {\n        return new LogContext(\"[AdminClient clientId=\" + clientId + \"] \");\n    }\n\n    private KafkaAdminClient(AdminClientConfig config,\n                             String clientId,\n                             Time time,\n                             AdminMetadataManager metadataManager,\n                             Metrics metrics,\n                             KafkaClient client,\n                             TimeoutProcessorFactory timeoutProcessorFactory,\n                             LogContext logContext,\n                             Optional<ClientTelemetryReporter> clientTelemetryReporter) {\n        this.clientId = clientId;\n        this.log = logContext.logger(KafkaAdminClient.class);\n        this.logContext = logContext;\n        this.requestTimeoutMs = config.getInt(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG);\n        this.defaultApiTimeoutMs = configureDefaultApiTimeoutMs(config);\n        this.time = time;\n        this.metadataManager = metadataManager;\n        this.metrics = metrics;\n        this.client = client;\n        this.runnable = new AdminClientRunnable();\n        String threadName = NETWORK_THREAD_PREFIX + \" | \" + clientId;\n        this.thread = new KafkaThread(threadName, runnable, true);\n        this.timeoutProcessorFactory = (timeoutProcessorFactory == null) ?\n            new TimeoutProcessorFactory() : timeoutProcessorFactory;\n        this.maxRetries = config.getInt(AdminClientConfig.RETRIES_CONFIG);\n        this.retryBackoffMs = config.getLong(AdminClientConfig.RETRY_BACKOFF_MS_CONFIG);\n        this.retryBackoffMaxMs = config.getLong(AdminClientConfig.RETRY_BACKOFF_MAX_MS_CONFIG);\n        this.retryBackoff = new ExponentialBackoff(\n            retryBackoffMs,\n            CommonClientConfigs.RETRY_BACKOFF_EXP_BASE,\n            retryBackoffMaxMs,\n            CommonClientConfigs.RETRY_BACKOFF_JITTER);\n        this.clientTelemetryReporter = clientTelemetryReporter;\n        this.metadataRecoveryStrategy = MetadataRecoveryStrategy.forName(config.getString(AdminClientConfig.METADATA_RECOVERY_STRATEGY_CONFIG));\n        this.partitionLeaderCache = new PartitionLeaderCache();\n        this.adminFetchMetricsManager = new AdminFetchMetricsManager(metrics);\n        config.logUnused();\n        AppInfoParser.registerAppInfo(JMX_PREFIX, clientId, metrics, time.milliseconds());\n        log.debug(\"Kafka admin client initialized\");\n        thread.start();\n    }\n\n    /**\n     * If a default.api.timeout.ms has been explicitly specified, raise an error if it conflicts with request.timeout.ms.\n     * If no default.api.timeout.ms has been configured, then set its value as the max of the default and request.timeout.ms. Also we should probably log a warning.\n     * Otherwise, use the provided values for both configurations.\n     *\n     * @param config The configuration\n     */\n    private int configureDefaultApiTimeoutMs(AdminClientConfig config) {\n        int requestTimeoutMs = config.getInt(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG);\n        int defaultApiTimeoutMs = config.getInt(AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG);\n\n        if (defaultApiTimeoutMs < requestTimeoutMs) {\n            if (config.originals().containsKey(AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG)) {\n                throw new ConfigException(\"The specified value of \" + AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG +\n                    \" must be no smaller than the value of \" + AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG + \".\");\n            } else {\n                log.warn(\"Overriding the default value for {} ({}) with the explicitly configured request timeout {}\",\n                    AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG, this.defaultApiTimeoutMs,\n                    requestTimeoutMs);\n                return requestTimeoutMs;\n            }\n        }\n        return defaultApiTimeoutMs;\n    }\n\n    @Override\n    public void close(Duration timeout) {\n        long waitTimeMs = timeout.toMillis();",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java#L521-L670",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 521,
  "end_line": 670,
  "last_modified": "2026-02-06T01:16:27.585045",
  "source_type": "github"
}