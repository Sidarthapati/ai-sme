{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_ClusterConnectionStates.java_261",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/ClusterConnectionStates.java",
  "content": "        resetReconnectBackoff(nodeState);\n        resetConnectionSetupTimeout(nodeState);\n        connectingNodes.remove(id);\n    }\n\n    /**\n     * Enter the authentication failed state for the given node.\n     * @param id the connection identifier\n     * @param now the current time in ms\n     * @param exception the authentication exception\n     */\n    public void authenticationFailed(String id, long now, AuthenticationException exception) {\n        NodeConnectionState nodeState = nodeState(id);\n        nodeState.authenticationException = exception;\n        nodeState.state = ConnectionState.AUTHENTICATION_FAILED;\n        nodeState.lastConnectAttemptMs = now;\n        updateReconnectBackoff(nodeState);\n    }\n\n    /**\n     * Return true if the connection is in the READY state and currently not throttled.\n     *\n     * @param id the connection identifier\n     * @param now the current time in ms\n     */\n    public boolean isReady(String id, long now) {\n        return isReady(nodeState.get(id), now);\n    }\n\n    private boolean isReady(NodeConnectionState state, long now) {\n        return state != null && state.state == ConnectionState.READY && state.throttleUntilTimeMs <= now;\n    }\n\n    /**\n     * Return true if there is at least one node with connection in the READY state and not throttled. Returns false\n     * otherwise.\n     *\n     * @param now the current time in ms\n     */\n    public boolean hasReadyNodes(long now) {\n        for (Map.Entry<String, NodeConnectionState> entry : nodeState.entrySet()) {\n            if (isReady(entry.getValue(), now)) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    /**\n     * Return true if the connection has been established\n     * @param id The id of the node to check\n     */\n    public boolean isConnected(String id) {\n        NodeConnectionState state = nodeState.get(id);\n        return state != null && state.state.isConnected();\n    }\n\n    /**\n     * Return true if the connection has been disconnected\n     * @param id The id of the node to check\n     */\n    public boolean isDisconnected(String id) {\n        NodeConnectionState state = nodeState.get(id);\n        return state != null && state.state.isDisconnected();\n    }\n\n    /**\n     * Return authentication exception if an authentication error occurred\n     * @param id The id of the node to check\n     */\n    public AuthenticationException authenticationException(String id) {\n        NodeConnectionState state = nodeState.get(id);\n        return state != null ? state.authenticationException : null;\n    }\n\n    /**\n     * Resets the failure count for a node and sets the reconnect backoff to the base\n     * value configured via reconnect.backoff.ms\n     *\n     * @param nodeState The node state object to update\n     */\n    private void resetReconnectBackoff(NodeConnectionState nodeState) {\n        nodeState.failedAttempts = 0;\n        nodeState.reconnectBackoffMs = reconnectBackoff.backoff(0);\n    }\n\n    /**\n     * Resets the failure count for a node and sets the connection setup timeout to the base\n     * value configured via socket.connection.setup.timeout.ms\n     *\n     * @param nodeState The node state object to update\n     */\n    private void resetConnectionSetupTimeout(NodeConnectionState nodeState) {\n        nodeState.failedConnectAttempts = 0;\n        nodeState.connectionSetupTimeoutMs = connectionSetupTimeout.backoff(0);\n    }\n\n    /**\n     * Increment the failure counter, update the node reconnect backoff exponentially.\n     * The delay is reconnect.backoff.ms * 2**(failures - 1) * (+/- 20% random jitter)\n     * Up to a (pre-jitter) maximum of reconnect.backoff.max.ms\n     *\n     * @param nodeState The node state object to update\n     */\n    private void updateReconnectBackoff(NodeConnectionState nodeState) {\n        nodeState.reconnectBackoffMs = reconnectBackoff.backoff(nodeState.failedAttempts);\n        nodeState.failedAttempts++;\n    }\n\n    /**\n     * Increment the failure counter and update the node connection setup timeout exponentially.\n     * The delay is socket.connection.setup.timeout.ms * 2**(failures) * (+/- 20% random jitter)\n     * Up to a (pre-jitter) maximum of socket.connection.setup.timeout.max.ms\n     *\n     * @param nodeState The node state object to update\n     */\n    private void updateConnectionSetupTimeout(NodeConnectionState nodeState) {\n        nodeState.failedConnectAttempts++;\n        nodeState.connectionSetupTimeoutMs = connectionSetupTimeout.backoff(nodeState.failedConnectAttempts);\n    }\n\n    /**\n     * Remove the given node from the tracked connection states. The main difference between this and `disconnected`\n     * is the impact on `connectionDelay`: it will be 0 after this call whereas `reconnectBackoffMs` will be taken\n     * into account after `disconnected` is called.\n     *\n     * @param id the connection to remove\n     */\n    public void remove(String id) {\n        nodeState.remove(id);\n        connectingNodes.remove(id);\n    }\n\n    /**\n     * Get the state of a given connection.\n     * @param id the id of the connection\n     * @return the state of our connection\n     */\n    public ConnectionState connectionState(String id) {\n        return nodeState(id).state;\n    }\n\n    /**\n     * Get the state of a given node.\n     * @param id the connection to fetch the state for\n     */\n    private NodeConnectionState nodeState(String id) {\n        NodeConnectionState state = this.nodeState.get(id);\n        if (state == null)\n            throw new IllegalStateException(\"No entry found for connection \" + id);",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/ClusterConnectionStates.java#L261-L410",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/ClusterConnectionStates.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 261,
  "end_line": 410,
  "last_modified": "2026-02-06T01:16:27.577459",
  "source_type": "github"
}