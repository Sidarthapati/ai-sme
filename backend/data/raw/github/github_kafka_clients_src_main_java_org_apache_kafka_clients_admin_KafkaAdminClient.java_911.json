{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_admin_KafkaAdminClient.java_911",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "content": "                return;\n            }\n            // If this is an UnsupportedVersionException that we can retry, do so. Note that a\n            // protocol downgrade will not count against the total number of retries we get for\n            // this RPC. That is why 'tries' is not incremented.\n            if ((throwable instanceof UnsupportedVersionException) &&\n                handleUnsupportedVersionException((UnsupportedVersionException) throwable)) {\n                log.debug(\"{} attempting protocol downgrade and then retry.\", this);\n                runnable.pendingCalls.add(this);\n                return;\n            }\n            nextAllowedTryMs = now + retryBackoff.backoff(tries++);\n\n            // If the call has timed out, fail.\n            if (calcTimeoutMsRemainingAsInt(now, deadlineMs) <= 0) {\n                handleTimeoutFailure(now, throwable);\n                return;\n            }\n            // If the exception is not retriable, fail.\n            if (!(throwable instanceof RetriableException)) {\n                if (log.isDebugEnabled()) {\n                    log.debug(\"{} failed with non-retriable exception after {} attempt(s)\", this, tries,\n                        new Exception(prettyPrintException(throwable)));\n                }\n                handleFailure(throwable);\n                return;\n            }\n            // If we are out of retries, fail.\n            if (tries > maxRetries) {\n                handleTimeoutFailure(now, throwable);\n                return;\n            }\n            if (log.isDebugEnabled()) {\n                log.debug(\"{} failed: {}. Beginning retry #{}\",\n                    this, prettyPrintException(throwable), tries);\n            }\n            maybeRetry(now, throwable);\n        }\n\n        void maybeRetry(long now, Throwable throwable) {\n            runnable.pendingCalls.add(this);\n        }\n\n        private void handleTimeoutFailure(long now, Throwable cause) {\n            if (log.isDebugEnabled()) {\n                log.debug(\"{} timed out at {} after {} attempt(s)\", this, now, tries,\n                    new Exception(prettyPrintException(cause)));\n            }\n            if (cause instanceof TimeoutException) {\n                handleFailure(cause);\n            } else {\n                handleFailure(new TimeoutException(this + \" timed out at \" + now\n                    + \" after \" + tries + \" attempt(s)\", cause));\n            }\n        }\n\n        /**\n         * Create an AbstractRequest.Builder for this Call.\n         *\n         * @param timeoutMs The timeout in milliseconds.\n         * @return The AbstractRequest builder.\n         */\n        abstract AbstractRequest.Builder<?> createRequest(int timeoutMs);\n\n        /**\n         * Process the call response.\n         *\n         * @param abstractResponse The AbstractResponse.\n         */\n        abstract void handleResponse(AbstractResponse abstractResponse);\n\n        /**\n         * Handle a failure. This will only be called if the failure exception was not\n         * retriable, or if we hit a timeout.\n         *\n         * @param throwable The exception.\n         */\n        abstract void handleFailure(Throwable throwable);\n\n        /**\n         * Handle an UnsupportedVersionException.\n         *\n         * @param exception The exception.\n         * @return True if the exception can be handled; false otherwise.\n         */\n        boolean handleUnsupportedVersionException(UnsupportedVersionException exception) {\n            return false;\n        }\n\n        @Override\n        public String toString() {\n            return \"Call(callName=\" + callName + \", deadlineMs=\" + deadlineMs +\n                \", tries=\" + tries + \", nextAllowedTryMs=\" + nextAllowedTryMs + \")\";\n        }\n\n        public boolean isInternal() {\n            return internal;\n        }\n    }\n\n    static class TimeoutProcessorFactory {\n        TimeoutProcessor create(long now) {\n            return new TimeoutProcessor(now);\n        }\n    }\n\n    static class TimeoutProcessor {\n        /**\n         * The current time in milliseconds.\n         */\n        private final long now;\n\n        /**\n         * The number of milliseconds until the next timeout.\n         */\n        private int nextTimeoutMs;\n\n        /**\n         * Create a new timeout processor.\n         *\n         * @param now The current time in milliseconds since the epoch.\n         */\n        TimeoutProcessor(long now) {\n            this.now = now;\n            this.nextTimeoutMs = Integer.MAX_VALUE;\n        }\n\n        /**\n         * Check for calls which have timed out.\n         * Timed out calls will be removed and failed.\n         * The remaining milliseconds until the next timeout will be updated.\n         *\n         * @param calls The collection of calls.\n         * @return The number of calls which were timed out.\n         */\n        int handleTimeouts(Collection<Call> calls, String msg) {\n            int numTimedOut = 0;\n            for (Iterator<Call> iter = calls.iterator(); iter.hasNext(); ) {\n                Call call = iter.next();\n                int remainingMs = calcTimeoutMsRemainingAsInt(now, call.deadlineMs);\n                if (remainingMs < 0) {\n                    call.fail(now, new TimeoutException(msg + \" Call: \" + call.callName));\n                    iter.remove();\n                    numTimedOut++;\n                } else {\n                    nextTimeoutMs = Math.min(nextTimeoutMs, remainingMs);\n                }\n            }\n            return numTimedOut;\n        }",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java#L911-L1060",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 911,
  "end_line": 1060,
  "last_modified": "2026-02-06T01:16:27.585045",
  "source_type": "github"
}