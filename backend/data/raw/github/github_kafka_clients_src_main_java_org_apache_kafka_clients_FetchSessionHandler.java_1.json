{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_FetchSessionHandler.java_1",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/FetchSessionHandler.java",
  "content": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License. You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage org.apache.kafka.clients;\n\nimport org.apache.kafka.common.TopicIdPartition;\nimport org.apache.kafka.common.TopicPartition;\nimport org.apache.kafka.common.Uuid;\nimport org.apache.kafka.common.protocol.Errors;\nimport org.apache.kafka.common.requests.FetchMetadata;\nimport org.apache.kafka.common.requests.FetchRequest.PartitionData;\nimport org.apache.kafka.common.requests.FetchResponse;\nimport org.apache.kafka.common.utils.LogContext;\n\nimport org.slf4j.Logger;\n\nimport java.util.ArrayList;\nimport java.util.Collection;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.Iterator;\nimport java.util.LinkedHashMap;\nimport java.util.LinkedHashSet;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Map.Entry;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\nimport static org.apache.kafka.common.requests.FetchMetadata.INVALID_SESSION_ID;\n\n/**\n * FetchSessionHandler maintains the fetch session state for connecting to a broker.\n *\n * Using the protocol outlined by KIP-227, clients can create incremental fetch sessions.\n * These sessions allow the client to fetch information about a set of partition over\n * and over, without explicitly enumerating all the partitions in the request and the\n * response.\n *\n * FetchSessionHandler tracks the partitions which are in the session.  It also\n * determines which partitions need to be included in each fetch request, and what\n * the attached fetch session metadata should be for each request.  The corresponding\n * class on the receiving broker side is FetchManager.\n */\npublic class FetchSessionHandler {\n    private final Logger log;\n\n    private final int node;\n\n    /**\n     * The metadata for the next fetch request.\n     */\n    private FetchMetadata nextMetadata = FetchMetadata.INITIAL;\n\n    public FetchSessionHandler(LogContext logContext, int node) {\n        this.log = logContext.logger(FetchSessionHandler.class);\n        this.node = node;\n    }\n\n    // visible for testing\n    public int sessionId() {\n        return nextMetadata.sessionId();\n    }\n\n    /**\n     * All of the partitions which exist in the fetch request session.\n     */\n    private LinkedHashMap<TopicPartition, PartitionData> sessionPartitions =\n        new LinkedHashMap<>(0);\n\n    /**\n     * All of the topic names mapped to topic ids for topics which exist in the fetch request session.\n     */\n    private Map<Uuid, String> sessionTopicNames = new HashMap<>(0);\n\n    public Map<Uuid, String> sessionTopicNames() {\n        return sessionTopicNames;\n    }\n\n    public static class FetchRequestData {\n        /**\n         * The partitions to send in the fetch request.\n         */\n        private final Map<TopicPartition, PartitionData> toSend;\n\n        /**\n         * The partitions to send in the request's \"forget\" list.\n         */\n        private final List<TopicIdPartition> toForget;\n\n        /**\n         * The partitions to send in the request's \"forget\" list if\n         * the version is >= 13.\n         */\n        private final List<TopicIdPartition> toReplace;\n\n        /**\n         * All of the partitions which exist in the fetch request session.\n         */\n        private final Map<TopicPartition, PartitionData> sessionPartitions;\n\n        /**\n         * The metadata to use in this fetch request.\n         */\n        private final FetchMetadata metadata;\n\n        /**\n         * A boolean indicating whether we have a topic ID for every topic in the request so that we can send a request that\n         * uses topic IDs\n         */\n        private final boolean canUseTopicIds;\n\n        FetchRequestData(Map<TopicPartition, PartitionData> toSend,\n                         List<TopicIdPartition> toForget,\n                         List<TopicIdPartition> toReplace,\n                         Map<TopicPartition, PartitionData> sessionPartitions,\n                         FetchMetadata metadata,\n                         boolean canUseTopicIds) {\n            this.toSend = toSend;\n            this.toForget = toForget;\n            this.toReplace = toReplace;\n            this.sessionPartitions = sessionPartitions;\n            this.metadata = metadata;\n            this.canUseTopicIds = canUseTopicIds;\n        }\n\n        /**\n         * Get the set of partitions to send in this fetch request.\n         */\n        public Map<TopicPartition, PartitionData> toSend() {\n            return toSend;\n        }\n\n        /**\n         * Get a list of partitions to forget in this fetch request.",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/FetchSessionHandler.java#L1-L150",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/FetchSessionHandler.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 1,
  "end_line": 150,
  "last_modified": "2026-02-06T01:16:27.577970",
  "source_type": "github"
}