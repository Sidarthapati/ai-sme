{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_producer_internals_KafkaProducerMetrics.java_1",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/producer/internals/KafkaProducerMetrics.java",
  "content": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License. You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage org.apache.kafka.clients.producer.internals;\n\nimport org.apache.kafka.common.MetricName;\nimport org.apache.kafka.common.metrics.Metrics;\nimport org.apache.kafka.common.metrics.Sensor;\nimport org.apache.kafka.common.metrics.stats.CumulativeSum;\n\nimport java.util.Map;\n\npublic class KafkaProducerMetrics implements AutoCloseable {\n\n    public static final String GROUP = \"producer-metrics\";\n    private static final String FLUSH = \"flush\";\n    private static final String TXN_INIT = \"txn-init\";\n    private static final String TXN_BEGIN = \"txn-begin\";\n    private static final String TXN_SEND_OFFSETS = \"txn-send-offsets\";\n    private static final String TXN_COMMIT = \"txn-commit\";\n    private static final String TXN_ABORT = \"txn-abort\";\n    private static final String TXN_PREPARE = \"txn-prepare\";\n    private static final String TOTAL_TIME_SUFFIX = \"-time-ns-total\";\n    private static final String METADATA_WAIT = \"metadata-wait\";\n\n    private final Map<String, String> tags;\n    private final Metrics metrics;\n    private final Sensor initTimeSensor;\n    private final Sensor beginTxnTimeSensor;\n    private final Sensor flushTimeSensor;\n    private final Sensor sendOffsetsSensor;\n    private final Sensor commitTxnSensor;\n    private final Sensor abortTxnSensor;\n    private final Sensor prepareTxnSensor;\n    private final Sensor metadataWaitSensor;\n\n    public KafkaProducerMetrics(Metrics metrics) {\n        this.metrics = metrics;\n        tags = this.metrics.config().tags();\n        flushTimeSensor = newLatencySensor(\n            FLUSH,\n            \"Total time producer has spent in flush in nanoseconds.\"\n        );\n        initTimeSensor = newLatencySensor(\n            TXN_INIT,\n            \"Total time producer has spent in initTransactions in nanoseconds.\"\n        );\n        beginTxnTimeSensor = newLatencySensor(\n            TXN_BEGIN,\n            \"Total time producer has spent in beginTransaction in nanoseconds.\"\n        );\n        sendOffsetsSensor = newLatencySensor(\n            TXN_SEND_OFFSETS,\n            \"Total time producer has spent in sendOffsetsToTransaction in nanoseconds.\"\n        );\n        commitTxnSensor = newLatencySensor(\n            TXN_COMMIT,\n            \"Total time producer has spent in commitTransaction in nanoseconds.\"\n        );\n        abortTxnSensor = newLatencySensor(\n            TXN_ABORT,\n            \"Total time producer has spent in abortTransaction in nanoseconds.\"\n        );\n        prepareTxnSensor = newLatencySensor(\n            TXN_PREPARE,\n            \"Total time producer has spent in prepareTransaction in nanoseconds.\"\n        );\n        metadataWaitSensor = newLatencySensor(\n            METADATA_WAIT,\n            \"Total time producer has spent waiting on topic metadata in nanoseconds.\"\n        );\n    }\n\n    @Override\n    public void close() {\n        removeMetric(FLUSH);\n        removeMetric(TXN_INIT);\n        removeMetric(TXN_BEGIN);\n        removeMetric(TXN_SEND_OFFSETS);\n        removeMetric(TXN_COMMIT);\n        removeMetric(TXN_ABORT);\n        removeMetric(TXN_PREPARE);\n        removeMetric(METADATA_WAIT);\n    }\n\n    public void recordFlush(long duration) {\n        flushTimeSensor.record(duration);\n    }\n\n    public void recordInit(long duration) {\n        initTimeSensor.record(duration);\n    }\n\n    public void recordBeginTxn(long duration) {\n        beginTxnTimeSensor.record(duration);\n    }\n\n    public void recordSendOffsets(long duration) {\n        sendOffsetsSensor.record(duration);\n    }\n\n    public void recordCommitTxn(long duration) {\n        commitTxnSensor.record(duration);\n    }\n\n    public void recordAbortTxn(long duration) {\n        abortTxnSensor.record(duration);\n    }\n\n    public void recordPrepareTxn(long duration) {\n        prepareTxnSensor.record(duration);\n    }\n\n    public void recordMetadataWait(long duration) {\n        metadataWaitSensor.record(duration);\n    }\n\n    private Sensor newLatencySensor(String name, String description) {\n        Sensor sensor = metrics.sensor(name + TOTAL_TIME_SUFFIX);\n        sensor.add(metricName(name, description), new CumulativeSum());\n        return sensor;\n    }\n\n    private MetricName metricName(final String name, final String description) {\n        return metrics.metricName(name + TOTAL_TIME_SUFFIX, GROUP, description, tags);\n    }\n\n    private void removeMetric(final String name) {\n        metrics.removeSensor(name + TOTAL_TIME_SUFFIX);\n    }\n}\n",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/KafkaProducerMetrics.java#L1-L146",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/KafkaProducerMetrics.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 1,
  "end_line": 146,
  "last_modified": "2026-02-06T01:16:27.609522",
  "source_type": "github"
}