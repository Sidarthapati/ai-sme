{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_NodeApiVersions.java_131",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java",
  "content": "        this.supportedFeatures = Collections.unmodifiableMap(supportedFeaturesBuilder);\n        this.finalizedFeaturesEpoch = finalizedFeaturesEpoch;\n        this.finalizedFeatures = new HashMap<>();\n        for (ApiVersionsResponseData.FinalizedFeatureKey finalizedFeature : nodeFinalizedFeatures) {\n            this.finalizedFeatures.put(finalizedFeature.name(), finalizedFeature.maxVersionLevel());\n        }\n    }\n\n    /**\n     * Return the most recent version supported by both the node and the local software.\n     */\n    public short latestUsableVersion(ApiKeys apiKey) {\n        return latestUsableVersion(apiKey, apiKey.oldestVersion(), apiKey.latestVersion());\n    }\n\n    /**\n     * Get the latest version supported by the broker within an allowed range of versions\n     */\n    public short latestUsableVersion(ApiKeys apiKey, short oldestAllowedVersion, short latestAllowedVersion) {\n        if (!supportedVersions.containsKey(apiKey))\n            throw new UnsupportedVersionException(\"The node does not support \" + apiKey);\n        ApiVersion supportedVersion = supportedVersions.get(apiKey);\n        Optional<ApiVersion> intersectVersion = ApiVersionsResponse.intersect(supportedVersion,\n            new ApiVersion()\n                .setApiKey(apiKey.id)\n                .setMinVersion(oldestAllowedVersion)\n                .setMaxVersion(latestAllowedVersion));\n\n        if (intersectVersion.isPresent())\n            return intersectVersion.get().maxVersion();\n        else\n            throw new UnsupportedVersionException(\"The node does not support \" + apiKey +\n                \" with version in range [\" + oldestAllowedVersion + \",\" + latestAllowedVersion + \"]. The supported\" +\n                \" range is [\" + supportedVersion.minVersion() + \",\" + supportedVersion.maxVersion() + \"].\");\n    }\n\n    /**\n     * Convert the object to a string with no linebreaks.<p/>\n     * <p>\n     * This toString method is relatively expensive, so avoid calling it unless debug logging is turned on.\n     */\n    @Override\n    public String toString() {\n        return toString(false);\n    }\n\n    /**\n     * Convert the object to a string.\n     *\n     * @param lineBreaks True if we should add a linebreak after each api.\n     */\n    public String toString(boolean lineBreaks) {\n        // The apiVersion collection may not be in sorted order.  We put it into\n        // a TreeMap before printing it out to ensure that we always print in\n        // ascending order.\n        TreeMap<Short, String> apiKeysText = new TreeMap<>();\n        for (ApiVersion supportedVersion : this.supportedVersions.values())\n            apiKeysText.put(supportedVersion.apiKey(), apiVersionToText(supportedVersion));\n        for (ApiVersion apiVersion : unknownApis)\n            apiKeysText.put(apiVersion.apiKey(), apiVersionToText(apiVersion));\n\n        // Also handle the case where some apiKey types are not specified at all in the given ApiVersions,\n        // which may happen when the remote is too old.\n        for (ApiKeys apiKey : ApiKeys.clientApis()) {\n            if (!apiKeysText.containsKey(apiKey.id)) {\n                String bld = apiKey.name + \"(\" +\n                        apiKey.id + \"): \" + \"UNSUPPORTED\";\n                apiKeysText.put(apiKey.id, bld);\n            }\n        }\n        String separator = lineBreaks ? \",\\n\\t\" : \", \";\n        StringBuilder bld = new StringBuilder();\n        bld.append(\"(\");\n        if (lineBreaks)\n            bld.append(\"\\n\\t\");\n        bld.append(String.join(separator, apiKeysText.values()));\n        if (lineBreaks)\n            bld.append(\"\\n\");\n        bld.append(\")\");\n        return bld.toString();\n    }\n\n    private String apiVersionToText(ApiVersion apiVersion) {\n        StringBuilder bld = new StringBuilder();\n        ApiKeys apiKey = null;\n        if (ApiKeys.hasId(apiVersion.apiKey())) {\n            apiKey = ApiKeys.forId(apiVersion.apiKey());\n            bld.append(apiKey.name).append(\"(\").append(apiKey.id).append(\"): \");\n        } else {\n            bld.append(\"UNKNOWN(\").append(apiVersion.apiKey()).append(\"): \");\n        }\n\n        if (apiVersion.minVersion() == apiVersion.maxVersion()) {\n            bld.append(apiVersion.minVersion());\n        } else {\n            bld.append(apiVersion.minVersion()).append(\" to \").append(apiVersion.maxVersion());\n        }\n\n        if (apiKey != null) {\n            ApiVersion supportedVersion = supportedVersions.get(apiKey);\n            if (apiKey.latestVersion() < supportedVersion.minVersion()) {\n                bld.append(\" [unusable: node too new]\");\n            } else if (supportedVersion.maxVersion() < apiKey.oldestVersion()) {\n                bld.append(\" [unusable: node too old]\");\n            } else {\n                short latestUsableVersion = Utils.min(apiKey.latestVersion(), supportedVersion.maxVersion());\n                bld.append(\" [usable: \").append(latestUsableVersion).append(\"]\");\n            }\n        }\n        return bld.toString();\n    }\n\n    /**\n     * Get the version information for a given API.\n     *\n     * @param apiKey The api key to lookup\n     * @return The api version information from the broker or null if it is unsupported\n     */\n    public ApiVersion apiVersion(ApiKeys apiKey) {\n        return supportedVersions.get(apiKey);\n    }\n\n    public Map<ApiKeys, ApiVersion> allSupportedApiVersions() {\n        return supportedVersions;\n    }\n\n    public Map<String, SupportedVersionRange> supportedFeatures() {\n        return supportedFeatures;\n    }\n\n    public Map<String, Short> finalizedFeatures() {\n        return finalizedFeatures;\n    }\n\n    public long finalizedFeaturesEpoch() {\n        return finalizedFeaturesEpoch;\n    }\n}\n",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java#L131-L269",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/NodeApiVersions.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 131,
  "end_line": 269,
  "last_modified": "2026-02-06T01:16:27.578999",
  "source_type": "github"
}