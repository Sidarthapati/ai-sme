{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_producer_internals_Sender.java_1",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java",
  "content": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License. You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.apache.kafka.clients.producer.internals;\n\nimport org.apache.kafka.clients.ClientRequest;\nimport org.apache.kafka.clients.ClientResponse;\nimport org.apache.kafka.clients.KafkaClient;\nimport org.apache.kafka.clients.Metadata;\nimport org.apache.kafka.clients.MetadataSnapshot;\nimport org.apache.kafka.clients.NetworkClientUtils;\nimport org.apache.kafka.clients.RequestCompletionHandler;\nimport org.apache.kafka.common.InvalidRecordException;\nimport org.apache.kafka.common.KafkaException;\nimport org.apache.kafka.common.MetricName;\nimport org.apache.kafka.common.Node;\nimport org.apache.kafka.common.TopicPartition;\nimport org.apache.kafka.common.Uuid;\nimport org.apache.kafka.common.errors.AuthenticationException;\nimport org.apache.kafka.common.errors.ClusterAuthorizationException;\nimport org.apache.kafka.common.errors.FencedLeaderEpochException;\nimport org.apache.kafka.common.errors.InvalidMetadataException;\nimport org.apache.kafka.common.errors.NotLeaderOrFollowerException;\nimport org.apache.kafka.common.errors.RetriableException;\nimport org.apache.kafka.common.errors.TimeoutException;\nimport org.apache.kafka.common.errors.TopicAuthorizationException;\nimport org.apache.kafka.common.errors.TransactionAbortedException;\nimport org.apache.kafka.common.errors.TransactionalIdAuthorizationException;\nimport org.apache.kafka.common.errors.UnknownTopicOrPartitionException;\nimport org.apache.kafka.common.message.ProduceRequestData;\nimport org.apache.kafka.common.metrics.Sensor;\nimport org.apache.kafka.common.metrics.stats.Avg;\nimport org.apache.kafka.common.metrics.stats.Max;\nimport org.apache.kafka.common.metrics.stats.Meter;\nimport org.apache.kafka.common.protocol.Errors;\nimport org.apache.kafka.common.record.MemoryRecords;\nimport org.apache.kafka.common.record.RecordBatch;\nimport org.apache.kafka.common.requests.AbstractRequest;\nimport org.apache.kafka.common.requests.FindCoordinatorRequest;\nimport org.apache.kafka.common.requests.ProduceRequest;\nimport org.apache.kafka.common.requests.ProduceResponse;\nimport org.apache.kafka.common.requests.RequestHeader;\nimport org.apache.kafka.common.utils.KafkaThread;\nimport org.apache.kafka.common.utils.LogContext;\nimport org.apache.kafka.common.utils.Time;\n\nimport org.slf4j.Logger;\n\nimport java.io.IOException;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Iterator;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.Objects;\nimport java.util.Optional;\nimport java.util.Set;\nimport java.util.function.Function;\nimport java.util.stream.Collectors;\n\n/**\n * The background thread that handles the sending of produce requests to the Kafka cluster. This thread makes metadata\n * requests to renew its view of the cluster and then sends produce requests to the appropriate nodes.\n */\npublic class Sender implements Runnable {\n\n    private final Logger log;\n\n    /* the client for sending requests to the Kafka cluster */\n    private final KafkaClient client;\n\n    /* the record accumulator that batches records */\n    private final RecordAccumulator accumulator;\n\n    /* the metadata for the client */\n    private final ProducerMetadata metadata;\n\n    /* the flag indicating whether the producer should guarantee the message order on the broker or not. */\n    private final boolean guaranteeMessageOrder;\n\n    /* the maximum request size to attempt to send to the server */\n    private final int maxRequestSize;\n\n    /* the number of acknowledgements to request from the server */\n    private final short acks;\n\n    /* the number of times to retry a failed request before giving up */\n    private final int retries;\n\n    /* the clock instance used for getting the time */\n    private final Time time;\n\n    /* true while the sender thread is still running */\n    private volatile boolean running;\n\n    /* true when the caller wants to ignore all unsent/inflight messages and force close.  */\n    private volatile boolean forceClose;\n\n    /* metrics */\n    private final SenderMetrics sensors;\n\n    /* the max time to wait for the server to respond to the request*/\n    private final int requestTimeoutMs;\n\n    /* The max time to wait before retrying a request which has failed */\n    private final long retryBackoffMs;\n\n    /* all the state related to transactions, in particular the producer id, producer epoch, and sequence numbers */\n    private final TransactionManager transactionManager;\n\n    // A per-partition queue of batches ordered by creation time for tracking the in-flight batches\n    private final Map<TopicPartition, List<ProducerBatch>> inFlightBatches;\n\n    public Sender(LogContext logContext,\n                  KafkaClient client,\n                  ProducerMetadata metadata,\n                  RecordAccumulator accumulator,\n                  boolean guaranteeMessageOrder,\n                  int maxRequestSize,\n                  short acks,\n                  int retries,\n                  SenderMetricsRegistry metricsRegistry,\n                  Time time,\n                  int requestTimeoutMs,\n                  long retryBackoffMs,\n                  TransactionManager transactionManager) {\n        this.log = logContext.logger(Sender.class);\n        this.client = client;\n        this.accumulator = accumulator;\n        this.metadata = metadata;\n        this.guaranteeMessageOrder = guaranteeMessageOrder;\n        this.maxRequestSize = maxRequestSize;\n        this.running = true;\n        this.acks = acks;\n        this.retries = retries;\n        this.time = time;",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java#L1-L150",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 1,
  "end_line": 150,
  "last_modified": "2026-02-06T01:16:27.610196",
  "source_type": "github"
}