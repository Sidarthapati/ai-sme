{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_producer_MockProducer.java_521",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java",
  "content": "     * Clear the stored history of sent records, consumer group offsets\n     */\n    public synchronized void clear() {\n        this.sent.clear();\n        this.uncommittedSends.clear();\n        this.sentOffsets = false;\n        this.completions.clear();\n        this.consumerGroupOffsets.clear();\n        this.uncommittedConsumerGroupOffsets.clear();\n    }\n\n    /**\n     * Complete the earliest uncompleted call successfully.\n     *\n     * @return true if there was an uncompleted call to complete\n     */\n    public synchronized boolean completeNext() {\n        return errorNext(null);\n    }\n\n    /**\n     * Complete the earliest uncompleted call with the given error.\n     *\n     * @return true if there was an uncompleted call to complete\n     */\n    public synchronized boolean errorNext(RuntimeException e) {\n        Completion completion = this.completions.pollFirst();\n        if (completion != null) {\n            completion.complete(e);\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    /**\n     * computes partition for given record.\n     */\n    private int partition(ProducerRecord<K, V> record, Cluster cluster) {\n        Integer partition = record.partition();\n        String topic = record.topic();\n        if (partition != null) {\n            List<PartitionInfo> partitions = cluster.partitionsForTopic(topic);\n            int numPartitions = partitions.size();\n            // they have given us a partition, use it\n            if (partition < 0 || partition >= numPartitions)\n                throw new IllegalArgumentException(\"Invalid partition given with record: \" + partition\n                                                   + \" is not in the range [0...\"\n                                                   + numPartitions\n                                                   + \"].\");\n            return partition;\n        }\n        byte[] keyBytes = keySerializer.serialize(topic, record.headers(), record.key());\n        byte[] valueBytes = valueSerializer.serialize(topic, record.headers(), record.value());\n        if (partitioner == null) {\n            return this.cluster.partitionsForTopic(record.topic()).get(0).partition();\n        }\n        return this.partitioner.partition(topic, record.key(), keyBytes, record.value(), valueBytes, cluster);\n    }\n\n    private static class Completion {\n        private final long offset;\n        private final RecordMetadata metadata;\n        private final ProduceRequestResult result;\n        private final Callback callback;\n        private final TopicPartition tp;\n\n        public Completion(long offset,\n                          RecordMetadata metadata,\n                          ProduceRequestResult result,\n                          Callback callback,\n                          TopicPartition tp) {\n            this.metadata = metadata;\n            this.offset = offset;\n            this.result = result;\n            this.callback = callback;\n            this.tp = tp;\n        }\n\n        public void complete(RuntimeException e) {\n            if (e == null) {\n                result.set(offset, RecordBatch.NO_TIMESTAMP, null);\n            } else {\n                result.set(-1, RecordBatch.NO_TIMESTAMP, index -> e);\n            }\n\n            if (callback != null) {\n                if (e == null)\n                    callback.onCompletion(metadata, null);\n                else\n                    callback.onCompletion(new RecordMetadata(tp, -1, -1, RecordBatch.NO_TIMESTAMP, -1, -1), e);\n            }\n            result.done();\n        }\n    }\n\n    public List<KafkaMetric> addedMetrics() {\n        return Collections.unmodifiableList(addedMetrics);\n    }\n\n    @Override\n    public void registerMetricForSubscription(KafkaMetric metric) {\n        addedMetrics.add(metric);\n    }\n\n    @Override\n    public void unregisterMetricFromSubscription(KafkaMetric metric) {\n        addedMetrics.remove(metric);\n    }\n}\n",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java#L521-L631",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 521,
  "end_line": 631,
  "last_modified": "2026-02-06T01:16:27.608364",
  "source_type": "github"
}