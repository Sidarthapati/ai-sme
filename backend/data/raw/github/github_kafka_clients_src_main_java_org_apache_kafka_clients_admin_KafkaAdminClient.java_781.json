{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_admin_KafkaAdminClient.java_781",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "content": "\n        ControllerNodeProvider(boolean supportsUseControllers) {\n            this.supportsUseControllers = supportsUseControllers;\n        }\n\n        ControllerNodeProvider() {\n            this.supportsUseControllers = false;\n        }\n\n        @Override\n        public Node provide() {\n            if (metadataManager.isReady() &&\n                (metadataManager.controller() != null)) {\n                return metadataManager.controller();\n            }\n            metadataManager.requestUpdate();\n            return null;\n        }\n\n        @Override\n        public boolean supportsUseControllers() {\n            return supportsUseControllers;\n        }\n    }\n\n    /**\n     * Provides the least loaded node.\n     */\n    private class LeastLoadedNodeProvider implements NodeProvider {\n        @Override\n        public Node provide() {\n            if (metadataManager.isReady()) {\n                // This may return null if all nodes are busy.\n                // In that case, we will postpone node assignment.\n                return client.leastLoadedNode(time.milliseconds()).node();\n            }\n            metadataManager.requestUpdate();\n            return null;\n        }\n\n        @Override\n        public boolean supportsUseControllers() {\n            return false;\n        }\n    }\n\n    /**\n     * Provides the least loaded broker, or the active kcontroller if we're using\n     * bootstrap.controllers.\n     */\n    private class LeastLoadedBrokerOrActiveKController implements NodeProvider {\n        @Override\n        public Node provide() {\n            if (metadataManager.isReady()) {\n                if (metadataManager.usingBootstrapControllers()) {\n                    return metadataManager.controller();\n                } else {\n                    // This may return null if all nodes are busy.\n                    // In that case, we will postpone node assignment.\n                    return client.leastLoadedNode(time.milliseconds()).node();\n                }\n            }\n            metadataManager.requestUpdate();\n            return null;\n        }\n\n        @Override\n        public boolean supportsUseControllers() {\n            return true;\n        }\n    }\n\n    abstract class Call {\n        private final boolean internal;\n        private final String callName;\n        private final long deadlineMs;\n        private final NodeProvider nodeProvider;\n        protected int tries;\n        private Node curNode = null;\n        private long nextAllowedTryMs;\n\n        Call(boolean internal,\n             String callName,\n             long nextAllowedTryMs,\n             int tries,\n             long deadlineMs,\n             NodeProvider nodeProvider\n        ) {\n            this.internal = internal;\n            this.callName = callName;\n            this.nextAllowedTryMs = nextAllowedTryMs;\n            this.tries = tries;\n            this.deadlineMs = deadlineMs;\n            this.nodeProvider = nodeProvider;\n        }\n\n        Call(boolean internal, String callName, long deadlineMs, NodeProvider nodeProvider) {\n            this(internal, callName, 0, 0, deadlineMs, nodeProvider);\n        }\n\n        Call(String callName, long deadlineMs, NodeProvider nodeProvider) {\n            this(false, callName, 0, 0, deadlineMs, nodeProvider);\n        }\n\n        Call(String callName, long nextAllowedTryMs, int tries, long deadlineMs, NodeProvider nodeProvider) {\n            this(false, callName, nextAllowedTryMs, tries, deadlineMs, nodeProvider);\n        }\n\n        protected Node curNode() {\n            return curNode;\n        }\n\n        /**\n         * Handle a failure.\n         * <p>\n         * Depending on what the exception is and how many times we have already tried, we may choose to\n         * fail the Call, or retry it. It is important to print the stack traces here in some cases,\n         * since they are not necessarily preserved in ApiVersionException objects.\n         *\n         * @param now       The current time in milliseconds.\n         * @param throwable The failure exception.\n         */\n        final void fail(long now, Throwable throwable) {\n            if (curNode != null) {\n                runnable.nodeReadyDeadlines.remove(curNode);\n                curNode = null;\n            }\n            // If the admin client is closing, we can't retry.\n            if (runnable.closing) {\n                handleFailure(throwable);\n                return;\n            }\n            // If this is an UnsupportedVersionException that we can retry, do so. Note that a\n            // protocol downgrade will not count against the total number of retries we get for\n            // this RPC. That is why 'tries' is not incremented.\n            if ((throwable instanceof UnsupportedVersionException) &&\n                handleUnsupportedVersionException((UnsupportedVersionException) throwable)) {\n                log.debug(\"{} attempting protocol downgrade and then retry.\", this);\n                runnable.pendingCalls.add(this);\n                return;\n            }\n            nextAllowedTryMs = now + retryBackoff.backoff(tries++);\n\n            // If the call has timed out, fail.\n            if (calcTimeoutMsRemainingAsInt(now, deadlineMs) <= 0) {\n                handleTimeoutFailure(now, throwable);\n                return;\n            }\n            // If the exception is not retriable, fail.\n            if (!(throwable instanceof RetriableException)) {",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java#L781-L930",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 781,
  "end_line": 930,
  "last_modified": "2026-02-06T01:16:27.585045",
  "source_type": "github"
}