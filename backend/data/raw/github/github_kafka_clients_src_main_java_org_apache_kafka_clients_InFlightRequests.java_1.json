{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_InFlightRequests.java_1",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/InFlightRequests.java",
  "content": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements. See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License. You may obtain a copy of the License at\n *\n *    http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.apache.kafka.clients;\n\nimport java.util.ArrayDeque;\nimport java.util.ArrayList;\nimport java.util.Collections;\nimport java.util.Deque;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.util.concurrent.atomic.AtomicInteger;\n\n/**\n * The set of requests which have been sent or are being sent but haven't yet received a response\n */\nfinal class InFlightRequests {\n\n    private final int maxInFlightRequestsPerConnection;\n    private final Map<String, Deque<NetworkClient.InFlightRequest>> requests = new HashMap<>();\n    /** Thread safe total number of in flight requests. */\n    private final AtomicInteger inFlightRequestCount = new AtomicInteger(0);\n\n    public InFlightRequests(int maxInFlightRequestsPerConnection) {\n        this.maxInFlightRequestsPerConnection = maxInFlightRequestsPerConnection;\n    }\n\n    /**\n     * Add the given request to the queue for the connection it was directed to\n     */\n    public void add(NetworkClient.InFlightRequest request) {\n        String destination = request.destination;\n        Deque<NetworkClient.InFlightRequest> reqs = this.requests.computeIfAbsent(destination, k -> new ArrayDeque<>());\n        reqs.addFirst(request);\n        inFlightRequestCount.incrementAndGet();\n    }\n\n    /**\n     * Get the request queue for the given node\n     */\n    private Deque<NetworkClient.InFlightRequest> requestQueue(String node) {\n        Deque<NetworkClient.InFlightRequest> reqs = requests.get(node);\n        if (reqs == null || reqs.isEmpty())\n            throw new IllegalStateException(\"There are no in-flight requests for node \" + node);\n        return reqs;\n    }\n\n    /**\n     * Get the oldest request (the one that will be completed next) for the given node\n     */\n    public NetworkClient.InFlightRequest completeNext(String node) {\n        NetworkClient.InFlightRequest inFlightRequest = requestQueue(node).pollLast();\n        inFlightRequestCount.decrementAndGet();\n        return inFlightRequest;\n    }\n\n    /**\n     * Get the last request we sent to the given node (but don't remove it from the queue)\n     * @param node The node id\n     */\n    public NetworkClient.InFlightRequest lastSent(String node) {\n        return requestQueue(node).peekFirst();\n    }\n\n    /**\n     * Complete the last request that was sent to a particular node.\n     * @param node The node the request was sent to\n     * @return The request\n     */\n    public NetworkClient.InFlightRequest completeLastSent(String node) {\n        NetworkClient.InFlightRequest inFlightRequest = requestQueue(node).pollFirst();\n        inFlightRequestCount.decrementAndGet();\n        return inFlightRequest;\n    }\n\n    /**\n     * Can we send more requests to this node?\n     *\n     * @param node Node in question\n     * @return true iff we have no requests still being sent to the given node\n     */\n    public boolean canSendMore(String node) {\n        Deque<NetworkClient.InFlightRequest> queue = requests.get(node);\n        return queue == null || queue.isEmpty() ||\n               (queue.peekFirst().send.completed() && queue.size() < this.maxInFlightRequestsPerConnection);\n    }\n\n    /**\n     * Return the number of in-flight requests directed at the given node\n     * @param node The node\n     * @return The request count.\n     */\n    public int count(String node) {\n        Deque<NetworkClient.InFlightRequest> queue = requests.get(node);\n        return queue == null ? 0 : queue.size();\n    }\n\n    /**\n     * Return true if there is no in-flight request directed at the given node and false otherwise\n     */\n    public boolean isEmpty(String node) {\n        Deque<NetworkClient.InFlightRequest> queue = requests.get(node);\n        return queue == null || queue.isEmpty();\n    }\n\n    /**\n     * Count all in-flight requests for all nodes. This method is thread safe, but may lag the actual count.\n     */\n    public int count() {\n        return inFlightRequestCount.get();\n    }\n\n    /**\n     * Return true if there is no in-flight request and false otherwise\n     */\n    public boolean isEmpty() {\n        for (Deque<NetworkClient.InFlightRequest> deque : this.requests.values()) {\n            if (!deque.isEmpty())\n                return false;\n        }\n        return true;\n    }\n\n    /**\n     * Clear out all the in-flight requests for the given node and return them\n     *\n     * @param node The node\n     * @return All the in-flight requests for that node that have been removed\n     */\n    public Iterable<NetworkClient.InFlightRequest> clearAll(String node) {\n        Deque<NetworkClient.InFlightRequest> reqs = requests.get(node);\n        if (reqs == null) {\n            return Collections.emptyList();\n        } else {\n            final Deque<NetworkClient.InFlightRequest> clearedRequests = requests.remove(node);\n            inFlightRequestCount.getAndAdd(-clearedRequests.size());",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/InFlightRequests.java#L1-L150",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/InFlightRequests.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 1,
  "end_line": 150,
  "last_modified": "2026-02-06T01:16:27.578181",
  "source_type": "github"
}