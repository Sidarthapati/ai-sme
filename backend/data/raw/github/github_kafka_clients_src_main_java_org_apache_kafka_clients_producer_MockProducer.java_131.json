{
  "id": "kafka_clients_src_main_java_org_apache_kafka_clients_producer_MockProducer.java_131",
  "title": "kafka/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java",
  "content": "                        final Serializer<V> valueSerializer) {\n        this(Cluster.empty(), autoComplete, partitioner, keySerializer, valueSerializer);\n    }\n\n    /**\n     * Create a new mock producer with invented metadata.\n     *\n     * Equivalent to {@link #MockProducer(Cluster, boolean, Partitioner, Serializer, Serializer) new MockProducer(Cluster.empty(), false, null, null, null)}\n     */\n    public MockProducer() {\n        this(Cluster.empty(), false, null, null, null);\n    }\n\n    @Override\n    public void initTransactions(boolean keepPreparedTxn) {\n        verifyNotClosed();\n        verifyNotFenced();\n        if (this.transactionInitialized) {\n            throw new IllegalStateException(\"MockProducer has already been initialized for transactions.\");\n        }\n        if (this.initTransactionException != null) {\n            throw this.initTransactionException;\n        }\n        this.transactionInitialized = true;\n        this.transactionInFlight = false;\n        this.transactionCommitted = false;\n        this.transactionAborted = false;\n        this.sentOffsets = false;\n    }\n\n    @Override\n    public void beginTransaction() throws ProducerFencedException {\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n\n        if (this.beginTransactionException != null) {\n            throw this.beginTransactionException;\n        }\n\n        if (transactionInFlight) {\n            throw new IllegalStateException(\"Transaction already started\");\n        }\n\n        this.transactionInFlight = true;\n        this.transactionCommitted = false;\n        this.transactionAborted = false;\n        this.sentOffsets = false;\n    }\n\n    @Override\n    public void sendOffsetsToTransaction(Map<TopicPartition, OffsetAndMetadata> offsets,\n                                         ConsumerGroupMetadata groupMetadata) throws ProducerFencedException {\n        Objects.requireNonNull(groupMetadata);\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n        verifyTransactionInFlight();\n\n        if (this.sendOffsetsToTransactionException != null) {\n            throw this.sendOffsetsToTransactionException;\n        }\n\n        if (offsets.isEmpty()) {\n            return;\n        }\n        Map<TopicPartition, OffsetAndMetadata> uncommittedOffsets =\n            this.uncommittedConsumerGroupOffsets.computeIfAbsent(groupMetadata.groupId(), k -> new HashMap<>());\n        uncommittedOffsets.putAll(offsets);\n        this.sentOffsets = true;\n    }\n\n    @Override\n    public PreparedTxnState prepareTransaction() throws ProducerFencedException {\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n        verifyTransactionInFlight();\n        \n        // Return a new PreparedTxnState with mock values for producerId and epoch\n        // Using 1000L and (short)1 as arbitrary values for a valid PreparedTxnState\n        return new PreparedTxnState(1000L, (short) 1);\n    }\n\n    @Override\n    public void commitTransaction() throws ProducerFencedException {\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n        verifyTransactionInFlight();\n\n        if (this.commitTransactionException != null) {\n            throw this.commitTransactionException;\n        }\n\n        flush();\n\n        this.sent.addAll(this.uncommittedSends);\n        if (!this.uncommittedConsumerGroupOffsets.isEmpty())\n            this.consumerGroupOffsets.add(this.uncommittedConsumerGroupOffsets);\n\n        this.uncommittedSends.clear();\n        this.uncommittedConsumerGroupOffsets = new HashMap<>();\n        this.transactionCommitted = true;\n        this.transactionAborted = false;\n        this.transactionInFlight = false;\n\n        ++this.commitCount;\n    }\n\n    @Override\n    public void abortTransaction() throws ProducerFencedException {\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n        verifyTransactionInFlight();\n\n        if (this.abortTransactionException != null) {\n            throw this.abortTransactionException;\n        }\n\n        flush();\n        this.uncommittedSends.clear();\n        this.uncommittedConsumerGroupOffsets.clear();\n        this.transactionCommitted = false;\n        this.transactionAborted = true;\n        this.transactionInFlight = false;\n    }\n\n    @Override\n    public void completeTransaction(PreparedTxnState preparedTxnState) throws ProducerFencedException {\n        verifyNotClosed();\n        verifyNotFenced();\n        verifyTransactionsInitialized();\n        \n        if (!this.transactionInFlight) {\n            throw new IllegalStateException(\"There is no prepared transaction to complete.\");\n        }\n\n        // For testing purposes, we'll consider a prepared state with producerId=1000L and epoch=1 as valid\n        // This should match what's returned in prepareTransaction()\n        PreparedTxnState currentState = new PreparedTxnState(1000L, (short) 1);\n        \n        if (currentState.equals(preparedTxnState)) {\n            commitTransaction();\n        } else {\n            abortTransaction();\n        }\n    }\n",
  "url": "https://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java#L131-L280",
  "file_path": "clients/src/main/java/org/apache/kafka/clients/producer/MockProducer.java",
  "repo_name": "kafka",
  "language": "java",
  "start_line": 131,
  "end_line": 280,
  "last_modified": "2026-02-06T01:16:27.608364",
  "source_type": "github"
}